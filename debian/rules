#!/usr/bin/make -f

include /usr/share/dpkg/default.mk

DESTDIR := debian/centreon-web

%:
	dh $@ --with apache2

override_dh_auto_clean:
	rm -fr log debian/centreon-web

override_dh_auto_build:

override_dh_auto_install:
	# FIXME
	mkdir -p $(DESTDIR)/usr/share/perl5/centreon/centreon
	export DESTDIR=$(DESTDIR) ; bash ./install.sh -f debian/varinstall-debian
	rm -f $(DESTDIR)/usr/share/centreon/filesUpload
	rm -f $(DESTDIR)/usr/share/centreon/installDir
	mkdir $(DESTDIR)/usr/share/centreon/filesUpload
	mkdir $(DESTDIR)/usr/share/centreon/installDir
	sed -i -e 's|@CENTREON_ETC@|/etc/centreon|' -e 's|@CENTREON_LOG@|/var/log/centreon|' -e 's|@CENTREON_VARLIB@|/var/lib/centreon|' $(DESTDIR)/usr/share/centreon/config/centreon.config.php
	sed -i -e 's/_CENTREON_PATH_PLACEHOLDER_/centreon/g' $(DESTDIR)/usr/share/centreon/www/index.php
	sed -i -e 's|@PHP_BIN@|/usr/bin/php|g' $(DESTDIR)/usr/share/centreon/bin/centreon
	sed -i -e 's|@PHP_BIN@|/usr/bin/php|g' $(DESTDIR)/usr/share/centreon/bin/export-mysql-indexes
	sed -i -e 's|@PHP_BIN@|/usr/bin/php|g' $(DESTDIR)/usr/share/centreon/bin/generateSqlLite
	sed -i -e 's|@PHP_BIN@|/usr/bin/php|g' $(DESTDIR)/usr/share/centreon/bin/import-mysql-indexes
	cd $(DESTDIR)/usr/share/centreon ; composer install --no-dev --optimize-autoloader
	cp package.json $(DESTDIR)/usr/share/centreon
	cd $(DESTDIR)/usr/share/centreon ; npm install ; npm run build ; npm prune --production
	find $(DESTDIR) -type f -print0 | xargs -0 sed -i -e "s|$(DESTDIR)||g"
